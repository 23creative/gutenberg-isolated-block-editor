{"version":3,"sources":["../../../src/store/blocks/reducer.js"],"names":["undoable","isShallowEqual","DEFAULT_STATE","editCount","selectionStart","selectionEnd","blocks","groupBy","action","currentState","previousHistory","getSelectedBlock","selection","find","block","clientId","isNewUndo","state","type","previousBlock","currentBlock","attributes","reducer"],"mappings":";;;;;;AAAA;AACA;AACA;AAEA,OAAOA,QAAP,MAAqB,YAArB;AACA,OAAOC,cAAP,MAA2B,6BAA3B;AAEA,IAAMC,aAAa,GAAG;AACrBC,EAAAA,SAAS,EAAE,CADU;AAErBC,EAAAA,cAAc,EAAE,IAFK;AAGrBC,EAAAA,YAAY,EAAE,IAHO;AAIrBC,EAAAA,MAAM,EAAE;AAJa,CAAtB;;AAOA,IAAMC,OAAO,GAAG,SAAVA,OAAU,CAAEC,MAAF,EAAUC,YAAV,EAAwBC,eAAxB,EAA6C;AAC5D,SAAOD,YAAY,CAACN,SAApB;AACA,CAFD;;AAIA,SAASQ,gBAAT,CAA2BL,MAA3B,EAAmCM,SAAnC,EAA+C;AAC9C,SAAON,MAAM,CAACO,IAAP,CAAa,UAAEC,KAAF;AAAA,WAAaA,KAAK,CAACC,QAAN,KAAmBH,SAAS,CAACG,QAA1C;AAAA,GAAb,CAAP;AACA,C,CAED;;;AACA,SAASC,SAAT,CAAoBR,MAApB,EAA4BS,KAA5B,EAAoC;AAAA,MAC3BC,IAD2B,GACYV,MADZ,CAC3BU,IAD2B;AAAA,MACrBd,cADqB,GACYI,MADZ,CACrBJ,cADqB;AAAA,MACLC,YADK,GACYG,MADZ,CACLH,YADK,EAGnC;;AACA,MAAKa,IAAI,KAAK,4BAAd,EAA6C;AAC5C,WAAO,KAAP;AACA,GANkC,CAQnC;;;AACA,MAAKjB,cAAc,CAAEG,cAAF,EAAkBa,KAAK,CAACb,cAAxB,CAAd,IAA0DH,cAAc,CAAEI,YAAF,EAAgBY,KAAK,CAACZ,YAAtB,CAA7E,EAAoH;AACnH,QAAMc,aAAa,GAAGR,gBAAgB,CAAEM,KAAK,CAACX,MAAR,EAAgBF,cAAhB,CAAtC;AACA,QAAMgB,YAAY,GAAGT,gBAAgB,CAAEH,MAAM,CAACF,MAAT,EAAiBF,cAAjB,CAArC,CAFmH,CAInH;;AACA,QAAKe,aAAa,IAAIC,YAAjB,IAAiCnB,cAAc,CAAEkB,aAAa,CAACE,UAAhB,EAA4BD,YAAY,CAACC,UAAzC,CAApD,EAA4G;AAC3G;AACA,aAAO,KAAP;AACA;AACD,GAlBkC,CAoBnC;;;AACA,SAAO,IAAP;AACA;;AAED,IAAMC,OAAO,GAAG,SAAVA,OAAU,GAAqC;AAAA,MAAnCL,KAAmC,uEAA3Bf,aAA2B;AAAA,MAAZM,MAAY;;AACpD,UAASA,MAAM,CAACU,IAAhB;AACC,SAAK,4BAAL;AACA,SAAK,yBAAL;AACC,6CACID,KADJ;AAECd,QAAAA,SAAS,EAAEa,SAAS,CAAER,MAAF,EAAUS,KAAV,CAAT,GAA6BA,KAAK,CAACd,SAAN,GAAkB,CAA/C,GAAmDc,KAAK,CAACd,SAFrE;AAGCC,QAAAA,cAAc,EAAEI,MAAM,CAACJ,cAHxB;AAICC,QAAAA,YAAY,EAAEG,MAAM,CAACH,YAJtB;AAKCC,QAAAA,MAAM,EAAEE,MAAM,CAACF;AALhB;AAHF;;AAYA,SAAOW,KAAP;AACA,CAdD;;AAgBA,eAAejB,QAAQ,CAAEsB,OAAF,EAAW;AACjCf,EAAAA,OAAO,EAAPA;AADiC,CAAX,CAAvB","sourcesContent":["/**\n * WordPress dependencies\n */\n\nimport undoable from 'redux-undo';\nimport isShallowEqual from '@wordpress/is-shallow-equal';\n\nconst DEFAULT_STATE = {\n\teditCount: 0,\n\tselectionStart: null,\n\tselectionEnd: null,\n\tblocks: null,\n};\n\nconst groupBy = ( action, currentState, previousHistory ) => {\n\treturn currentState.editCount;\n};\n\nfunction getSelectedBlock( blocks, selection ) {\n\treturn blocks.find( ( block ) => block.clientId === selection.clientId );\n}\n\n// Gutenberg triggers a UPDATE_BLOCKS_WITH_UNDO one second after typing. Try and group this with the previous edits\nfunction isNewUndo( action, state ) {\n\tconst { type, selectionStart, selectionEnd } = action;\n\n\t// Don't create a new undo when flagged as no undo\n\tif ( type === 'UPDATE_BLOCKS_WITHOUT_UNDO' ) {\n\t\treturn false;\n\t}\n\n\t// Not new if selection is same\n\tif ( isShallowEqual( selectionStart, state.selectionStart ) && isShallowEqual( selectionEnd, state.selectionEnd ) ) {\n\t\tconst previousBlock = getSelectedBlock( state.blocks, selectionStart );\n\t\tconst currentBlock = getSelectedBlock( action.blocks, selectionStart );\n\n\t\t// Check if any attributes have changed in the selected block\n\t\tif ( previousBlock && currentBlock && isShallowEqual( previousBlock.attributes, currentBlock.attributes ) ) {\n\t\t\t// Nothing has changed - not a new undo level\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t// Yes, a new undo level\n\treturn true;\n}\n\nconst reducer = ( state = DEFAULT_STATE, action ) => {\n\tswitch ( action.type ) {\n\t\tcase 'UPDATE_BLOCKS_WITHOUT_UNDO':\n\t\tcase 'UPDATE_BLOCKS_WITH_UNDO':\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\teditCount: isNewUndo( action, state ) ? state.editCount + 1 : state.editCount,\n\t\t\t\tselectionStart: action.selectionStart,\n\t\t\t\tselectionEnd: action.selectionEnd,\n\t\t\t\tblocks: action.blocks,\n\t\t\t};\n\t}\n\n\treturn state;\n};\n\nexport default undoable( reducer, {\n\tgroupBy,\n} );\n"],"file":"reducer.js"}