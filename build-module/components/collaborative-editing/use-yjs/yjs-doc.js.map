{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-doc.js"],"names":["yjs","encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","identity","applyChangesToYDoc","getPostFromYDoc","sendMessage","doc","Doc","state","yDocTriggeredChangeListeners","connectionReadyListeners","on","update","origin","newData","forEach","listener","isLocalOrigin","UndoManager","protocol","messageType","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","data","isInitialContent","transactionOrigin","transact","connect","disconnect","startSharing","receiveMessage","content","encodeStateAsUpdate","applyUpdate","onYDocTriggeredChange","push","filter","l","onConnectionReady","getState","getPostMap","getMap"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/** @typedef {import('./algorithms/yjs').PostObject} PostObject */\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\n/**\n * Create a Yjs document.\n *\n * @param {Object} opts\n * @param {string} opts.identity - Client identifier.\n * @param {function(yjs.Doc, PostObject): void} opts.applyChangesToYDoc - Function to apply changes to the Yjs doc.\n * @param {function(yjs.Doc): PostObject} opts.getPostFromYDoc - Function to get post object data from the Yjs doc.\n * @param {function(any): void} opts.sendMessage\n */\nexport function createDocument( { identity, applyChangesToYDoc, getPostFromYDoc, sendMessage } ) {\n\tconst doc = new yjs.Doc();\n\t/** @type {'off'|'connecting'|'on'} */\n\tlet state = 'off';\n\n\tlet yDocTriggeredChangeListeners = [];\n\tlet connectionReadyListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\t// Change received from peer, or triggered by self undo/redo\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = getPostFromYDoc( doc );\n\t\t\tyDocTriggeredChangeListeners.forEach( ( listener ) => listener( newData ) );\n\t\t}\n\n\t\tconst isLocalOrigin =\n\t\t\torigin === identity || origin === `no-undo--${ identity }` || origin instanceof yjs.UndoManager;\n\n\t\t// Change should be broadcast to peers\n\t\tif ( isLocalOrigin && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\n\t\tif ( newState === 'on' ) {\n\t\t\tconnectionReadyListeners.forEach( ( listener ) => listener() );\n\t\t}\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\tapplyChangesToYDoc( data, { isInitialContent = false } = {} ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tconst transactionOrigin = isInitialContent ? `no-undo--${ identity }` : identity;\n\n\t\t\tdoc.transact( () => {\n\t\t\t\tapplyChangesToYDoc( doc, data );\n\t\t\t}, transactionOrigin );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\n\t\t\tthis.applyChangesToYDoc( data, { isInitialContent: true } );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif ( content.destination && content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray( yjs.encodeStateAsUpdate( doc, decodeArray( content.stateVector ) ) ),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonYDocTriggeredChange( listener ) {\n\t\t\tyDocTriggeredChangeListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tyDocTriggeredChangeListeners = yDocTriggeredChangeListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonConnectionReady( listener ) {\n\t\t\tconnectionReadyListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tconnectionReadyListeners = connectionReadyListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\n\t\tgetPostMap() {\n\t\t\treturn doc.getMap( 'post' );\n\t\t},\n\t};\n}\n"],"file":"yjs-doc.js"}