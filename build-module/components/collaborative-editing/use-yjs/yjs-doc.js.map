{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-doc.js"],"names":["yjs","encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","identity","applyDataChanges","getData","sendMessage","doc","Doc","state","listeners","stateListeners","on","update","origin","protocol","messageType","newData","forEach","listener","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","data","transact","connect","disconnect","startSharing","receiveMessage","content","encodeStateAsUpdate","applyUpdate","onRemoteDataChange","push","filter","l","onStateChange","getState"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\nexport function createDocument( { identity, applyDataChanges, getData, sendMessage } ) {\n\tconst doc = new yjs.Doc();\n\tlet state = 'off';\n\tlet listeners = [];\n\tlet stateListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\tif ( origin === identity && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = getData( doc );\n\t\t\tlisteners.forEach( ( listener ) => listener( newData ) );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\t\tstateListeners.forEach( ( listener ) => listener( newState ) );\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\tapplyDataChanges( data ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\t\t\tdoc.transact( () => {\n\t\t\t\tapplyDataChanges( doc, data );\n\t\t\t}, identity );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\t\t\tthis.applyDataChanges( data );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif ( content.destination && content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray( yjs.encodeStateAsUpdate( doc, decodeArray( content.stateVector ) ) ),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonRemoteDataChange( listener ) {\n\t\t\tlisteners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tlisteners = listeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonStateChange( listener ) {\n\t\t\tstateListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tstateListeners = stateListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\t};\n}\n"],"file":"yjs-doc.js"}