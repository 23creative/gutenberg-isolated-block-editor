{"version":3,"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/relative-position.js"],"names":["yjs","RelativePosition","constructor","getSelection","selectionChange","saveRelativePosition","doc","start","end","clientId","attributeKey","richTexts","getMap","get","has","offset","xmlText","relPos","startOffset","createRelativePositionFromTypeIndex","endOffset","undefined","setAbsolutePosition","absStartOffset","createAbsolutePositionFromRelativePosition","index","absEndOffset","PeerRelativePosition","getPeers","setPeerSelection","_getPeers","_setPeerSelection","_initRelativePositionForPeer","peerId","peer","saveRelativePositions","_peerRelativePositions","Object","entries","map","forEach","setAbsolutePositions"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * @typedef WPBlockSelection\n * @property {string} [clientId]\n * @property {string} [attributeKey]\n * @property {number} [offset]\n */\n\n/**\n * @typedef SelectionRange\n * @property {WPBlockSelection} start\n * @property {WPBlockSelection} end\n */\n\n/**\n * @typedef RelativePositionManager\n * @property {RelativePosition} self\n * @property {PeerRelativePosition} peers\n */\n\n/**\n * Handle the conversion between a Yjs relative position and a Gutenberg absolute position.\n *\n * This is used to maintain a user's caret position so it doesn't look like it's pushed around by remote changes.\n * For example, if my caret is at `ab|c` and a remote user changes the text to `aabc`, I want my\n * caret to \"stay\" relative to the `b` (`aab|c`) instead of staying at the same absolute index (`aa|bc`).\n */\nexport class RelativePosition {\n\t/**\n\t * @param {() => SelectionRange} getSelection - Function to get block editor selection.\n\t * @param {(clientId: string, attributeKey: string, startOffset: number, endOffset: number) => void} selectionChange - Function to set block editor selection.\n\t */\n\tconstructor( getSelection, selectionChange ) {\n\t\tthis.getSelection = getSelection;\n\t\tthis.selectionChange = selectionChange;\n\t}\n\n\t/**\n\t * Get the current block editor selection, convert it to a Y.RelativePosition, and remember it.\n\t *\n\t * Call this method _before_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePosition( doc ) {\n\t\tconst { start, end } = this.getSelection();\n\t\tconst { clientId, attributeKey } = start ?? {};\n\t\tconst richTexts = doc.getMap( 'post' )?.get( 'blocks' )?.get( 'richTexts' );\n\n\t\tif (\n\t\t\trichTexts?.get( clientId )?.has( attributeKey ) &&\n\t\t\ttypeof start.offset === 'number' &&\n\t\t\ttypeof end.offset === 'number'\n\t\t) {\n\t\t\tconst xmlText = richTexts.get( clientId ).get( attributeKey ).get( 'xmlText' );\n\t\t\tthis.relPos = {\n\t\t\t\tclientId,\n\t\t\t\tattributeKey,\n\t\t\t\tstartOffset: yjs.createRelativePositionFromTypeIndex( xmlText, start.offset, -1 ),\n\t\t\t\tendOffset: yjs.createRelativePositionFromTypeIndex( xmlText, end.offset, -1 ),\n\t\t\t};\n\t\t} else {\n\t\t\tthis.relPos = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * If a saved Y.RelativePosition exists, convert it to an absolute position and\n\t * dispatch it as a selection change to the block editor.\n\t *\n\t * Call this method _after_ the Y.Doc is mutated.\n\t *\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePosition( doc ) {\n\t\tif ( ! this.relPos?.clientId || ! this.relPos?.attributeKey ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { clientId, attributeKey, startOffset, endOffset } = this.relPos;\n\t\tconst absStartOffset = yjs.createAbsolutePositionFromRelativePosition( startOffset, doc )?.index;\n\t\tconst absEndOffset = yjs.createAbsolutePositionFromRelativePosition( endOffset, doc )?.index;\n\n\t\tif ( typeof absStartOffset !== 'number' || typeof absEndOffset !== 'number' ) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectionChange( clientId, attributeKey, absStartOffset, absEndOffset );\n\t}\n}\n\nexport class PeerRelativePosition {\n\t/**\n\t * @private\n\t * @type {RelativePosition[]}\n\t */\n\t_peerRelativePositions = [];\n\n\t/**\n\t * @param {() => Record<string, Partial<SelectionRange>>} getPeers\n\t * @param {(peerId: string, selection: SelectionRange) => void} setPeerSelection\n\t */\n\tconstructor( getPeers, setPeerSelection ) {\n\t\t/** @private */\n\t\tthis._getPeers = getPeers;\n\t\t/** @private */\n\t\tthis._setPeerSelection = setPeerSelection;\n\t}\n\n\t/**\n\t * @private\n\t * @param {string} peerId\n\t * @param {Partial<SelectionRange>} peer\n\t * @returns {RelativePosition}\n\t */\n\t_initRelativePositionForPeer( peerId, peer ) {\n\t\treturn new RelativePosition(\n\t\t\t() => ( { start: peer.start ?? {}, end: peer.end ?? {} } ),\n\t\t\t( clientId, attributeKey, startOffset, endOffset ) =>\n\t\t\t\tthis._setPeerSelection( peerId, {\n\t\t\t\t\tstart: { clientId, attributeKey, offset: startOffset },\n\t\t\t\t\tend: { clientId, attributeKey, offset: endOffset },\n\t\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsaveRelativePositions( doc ) {\n\t\tthis._peerRelativePositions = Object.entries( this._getPeers() ).map( ( [ peerId, peer ] ) =>\n\t\t\tthis._initRelativePositionForPeer( peerId, peer )\n\t\t);\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.saveRelativePosition( doc ) );\n\t}\n\n\t/**\n\t * @param {yjs.Doc} doc\n\t */\n\tsetAbsolutePositions( doc ) {\n\t\tthis._peerRelativePositions.forEach( ( relPos ) => relPos.setAbsolutePosition( doc ) );\n\t}\n}\n"],"file":"relative-position.js"}