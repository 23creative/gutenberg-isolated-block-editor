{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"names":["v4","uuidv4","noop","sample","createDocument","postDocToObject","updatePostDoc","useDispatch","useSelect","useEffect","useRef","addCollabFilters","registerCollabFormats","debug","require","defaultColors","initYDoc","getBlocks","onRemoteDataChange","settings","getSelection","setPeerSelection","setAvailablePeers","channelId","transport","identity","doc","applyDataChanges","getData","sendMessage","message","type","selectionStart","selectionEnd","selection","start","end","onReceiveMessage","data","receiveMessage","changes","blocks","connect","user","name","username","color","caretColor","peers","then","isFirstInChannel","startSharing","title","disconnect","window","addEventListener","useYjs","applyChangesToYjs","select","getEditorSelection","updateBlocksWithUndo","enabled","console","error","onUnmount","current","getState"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, sample } from 'lodash';\nimport { createDocument } from './yjs-doc';\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/**\n * WordPress dependencies\n */\nimport { useDispatch, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\n\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n/** @typedef {import('..').CollaborationTransport} CollaborationTransport */\n/** @typedef {import('..').CollaborationTransportDocMessage} CollaborationTransportDocMessage */\n/** @typedef {import('..').CollaborationTransportSelectionMessage} CollaborationTransportSelectionMessage */\n/** @typedef {import('..').EditorSelection} EditorSelection */\n/** @typedef {import('../../block-editor-contents').OnUpdate} OnUpdate */\n\nconst defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {object} opts - Hook options\n * @param {() => object[]} opts.getBlocks - Content to initialize the Yjs doc with.\n * @param {OnUpdate} opts.onRemoteDataChange - Function to update editor blocks in redux state.\n * @param {CollaborationSettings} opts.settings\n * @param {() => IsoEditorSelection} opts.getSelection\n * @param {import('../../../store/peers/actions').setAvailablePeers} opts.setAvailablePeers\n * @param {import('../../../store/peers/actions').setPeerSelection} opts.setPeerSelection\n *\n * @typedef IsoEditorSelection\n * @property {object} selectionStart\n * @property {object} selectionEnd\n */\nasync function initYDoc( {\n\tgetBlocks,\n\tonRemoteDataChange,\n\tsettings,\n\tgetSelection,\n\tsetPeerSelection,\n\tsetAvailablePeers,\n} ) {\n\tconst { channelId, transport } = settings;\n\n\t/** @type string */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\tapplyDataChanges: updatePostDoc,\n\t\tgetData: postDocToObject,\n\t\t/** @param {object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\n\t\t\tconst { selectionStart, selectionEnd } = getSelection() || {};\n\t\t\tdebug( 'sendSelection', selectionStart, selectionEnd );\n\t\t\ttransport.sendMessage( {\n\t\t\t\ttype: 'selection',\n\t\t\t\tidentity,\n\t\t\t\tselection: {\n\t\t\t\t\tstart: selectionStart,\n\t\t\t\t\tend: selectionEnd,\n\t\t\t\t},\n\t\t\t} );\n\t\t},\n\t} );\n\n\t/** @param {CollaborationTransportDocMessage|CollaborationTransportSelectionMessage} data */\n\tconst onReceiveMessage = ( data ) => {\n\t\tdebug( 'remote change received by transport', data );\n\n\t\tswitch ( data.type ) {\n\t\t\tcase 'doc': {\n\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'selection': {\n\t\t\t\tsetPeerSelection( data.identity, data.selection );\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tdoc.onRemoteDataChange( ( changes ) => {\n\t\tdebug( 'remote change received by ydoc', changes );\n\t\tonRemoteDataChange( changes.blocks );\n\t} );\n\n\treturn transport\n\t\t.connect( {\n\t\t\tuser: {\n\t\t\t\tidentity,\n\t\t\t\tname: settings.username,\n\t\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\t},\n\t\t\tonReceiveMessage,\n\t\t\tsetAvailablePeers: ( peers ) => {\n\t\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\t\tsetAvailablePeers( peers );\n\t\t\t},\n\t\t\tchannelId,\n\t\t} )\n\t\t.then( ( { isFirstInChannel } ) => {\n\t\t\tdebug( `connected (channelId: ${ channelId })` );\n\n\t\t\tif ( isFirstInChannel ) {\n\t\t\t\tdebug( 'first in channel' );\n\n\t\t\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\t\t\tdoc.startSharing( { title: '', blocks: getBlocks() } );\n\t\t\t} else {\n\t\t\t\tdoc.connect();\n\t\t\t}\n\n\t\t\tconst disconnect = () => {\n\t\t\t\ttransport.disconnect();\n\t\t\t\tdoc.disconnect();\n\t\t\t};\n\n\t\t\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\t\t\treturn { doc, disconnect };\n\t\t} );\n}\n\n/**\n * @param {object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst applyChangesToYjs = useRef( noop );\n\n\tconst { blocks, getBlocks, getSelection } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\tblocks: select( 'isolated/editor' ).getBlocks(),\n\t\t\tgetBlocks: select( 'isolated/editor' ).getBlocks,\n\t\t\tgetSelection: select( 'isolated/editor' ).getEditorSelection,\n\t\t};\n\t}, [] );\n\n\tconst { setAvailablePeers, setPeerSelection, updateBlocksWithUndo } = useDispatch( 'isolated/editor' );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats();\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tonRemoteDataChange: updateBlocksWithUndo,\n\t\t\tsettings,\n\t\t\tgetBlocks,\n\t\t\tgetSelection,\n\t\t\tsetPeerSelection,\n\t\t\tsetAvailablePeers,\n\t\t} ).then( ( { doc, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tapplyChangesToYjs.current = ( blocks ) => {\n\t\t\t\tif ( doc.getState() !== 'on' ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tdebug( 'local changes applied to ydoc' );\n\t\t\t\tdoc.applyDataChanges( { blocks } );\n\t\t\t};\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tapplyChangesToYjs.current( blocks );\n\t}, [ blocks ] );\n}\n"],"file":"index.js"}