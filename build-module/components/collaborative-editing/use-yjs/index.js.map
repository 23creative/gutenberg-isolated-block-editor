{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"names":["v4","uuidv4","noop","once","sample","createDocument","postDocToObject","updatePostDoc","useRegistry","useSelect","useEffect","useRef","addCollabFilters","registerCollabFormats","setupUndoManager","debug","require","defaultColors","initYDoc","settings","registry","channelId","transport","dispatch","select","identity","doc","applyChangesToYDoc","getPostFromYDoc","sendMessage","message","type","onConnectionReady","setYDoc","getPostMap","onYDocTriggeredChange","changes","updateBlocksWithUndo","blocks","isTriggeredByYDoc","isFirstInChannel","connect","user","name","username","color","caretColor","avatarUrl","onReceiveMessage","data","receiveMessage","setCollabPeerSelection","selection","setAvailablePeers","peers","setAvailableCollabPeers","startSharing","title","getBlocks","disconnect","window","addEventListener","sendSelection","start","end","removeEventListener","useYjs","onSelectionChange","getFormatType","selectionStart","selectionEnd","getSelectionStart","getSelectionEnd","enabled","console","error","onUnmount","then","current"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, once, sample } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport { createDocument } from './yjs-doc';\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/**\n * WordPress dependencies\n */\nimport { useRegistry, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\nimport { setupUndoManager } from './yjs-undo';\n\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n\nexport const defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {Object} opts\n * @param {import('..').CollaborationSettings} opts.settings\n * @param {Object} opts.registry - Redux data registry for this context.\n */\nasync function initYDoc( { settings, registry } ) {\n\tconst { channelId, transport } = settings;\n\tconst { dispatch, select } = registry;\n\n\t/** @type {string} */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\tapplyChangesToYDoc: updatePostDoc,\n\t\tgetPostFromYDoc: postDocToObject,\n\t\t/** @param {Object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\t\t},\n\t} );\n\n\tdoc.onConnectionReady(\n\t\tonce( () => {\n\t\t\tdispatch( 'isolated/editor' ).setYDoc( doc );\n\t\t\tsetupUndoManager( doc.getPostMap(), identity, registry );\n\t\t} )\n\t);\n\n\tdoc.onYDocTriggeredChange( ( changes ) => {\n\t\tdebug( 'changes triggered by ydoc, applying to editor state', changes );\n\t\tdispatch( 'isolated/editor' ).updateBlocksWithUndo( changes.blocks, { isTriggeredByYDoc: true } );\n\t} );\n\n\tconst { isFirstInChannel } = await transport.connect( {\n\t\tuser: {\n\t\t\tidentity,\n\t\t\tname: settings.username,\n\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\tavatarUrl: settings.avatarUrl,\n\t\t},\n\t\t/** @param {import('..').CollaborationTransportMessage} data */\n\t\tonReceiveMessage: ( data ) => {\n\t\t\tdebug( 'remote change received by transport', data );\n\n\t\t\tswitch ( data.type ) {\n\t\t\t\tcase 'doc': {\n\t\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'selection': {\n\t\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection( data.identity, data.selection );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tsetAvailablePeers: ( peers ) => {\n\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\tdispatch( 'isolated/editor' ).setAvailableCollabPeers( peers );\n\t\t},\n\t\tchannelId,\n\t} );\n\n\tdebug( `connected (channelId: ${ channelId })` );\n\n\tif ( isFirstInChannel ) {\n\t\tdebug( 'first in channel' );\n\n\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\tdoc.startSharing( { title: '', blocks: select( 'core/block-editor' ).getBlocks() } );\n\t} else {\n\t\tdoc.connect();\n\t}\n\n\tconst disconnect = () => {\n\t\ttransport.disconnect();\n\t\tdoc.disconnect();\n\t};\n\n\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\treturn {\n\t\tsendSelection: ( start, end ) => {\n\t\t\tdebug( 'sendSelection', start, end );\n\t\t\ttransport.sendMessage( {\n\t\t\t\ttype: 'selection',\n\t\t\t\tidentity,\n\t\t\t\tselection: {\n\t\t\t\t\tstart,\n\t\t\t\t\tend,\n\t\t\t\t},\n\t\t\t} );\n\t\t},\n\t\tdisconnect: () => {\n\t\t\twindow.removeEventListener( 'beforeunload', disconnect );\n\t\t\tdisconnect();\n\t\t},\n\t};\n}\n\n/**\n * @param {Object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst onSelectionChange = useRef( noop );\n\tconst registry = useRegistry();\n\n\tconst { getFormatType, selectionStart, selectionEnd } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\tgetFormatType: select( 'core/rich-text' ).getFormatType,\n\t\t\tselectionStart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\tselectionEnd: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t};\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats( getFormatType );\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tsettings,\n\t\t\tregistry,\n\t\t} ).then( ( { sendSelection, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tonSelectionChange.current = sendSelection;\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tonSelectionChange.current( selectionStart, selectionEnd );\n\t}, [ selectionStart, selectionEnd ] );\n}\n"],"file":"index.js"}