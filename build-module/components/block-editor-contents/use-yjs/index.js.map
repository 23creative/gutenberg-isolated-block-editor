{"version":3,"sources":["../../../../src/components/block-editor-contents/use-yjs/index.js"],"names":["v4","uuidv4","debounce","noop","sample","createDocument","postDocToObject","updatePostDoc","useDispatch","useSelect","useEffect","useRef","registerFormatCollabCaret","debug","require","DEBOUNCE_WAIT_MS","defaultColors","initYDoc","blocks","onRemoteDataChange","settings","getSelection","setPeerSelection","setAvailablePeers","channelId","transport","identity","doc","applyDataChanges","getData","sendMessage","message","type","selectionStart","selectionEnd","selection","start","end","onReceiveMessage","data","receiveMessage","changes","connect","user","name","username","color","caretColor","peers","then","isFirstInChannel","startSharing","title","disconnect","window","addEventListener","useYjs","applyChangesToYjs","select","getEditorSelection","enabled","console","error","onUnmount","current"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as uuidv4 } from 'uuid';\nimport { debounce, noop, sample } from 'lodash';\nimport { createDocument } from './yjs-doc';\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/**\n * WordPress dependencies\n */\nimport { useDispatch, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\nimport { registerFormatCollabCaret } from '../../formats/collab-caret';\n\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('../../..').CollaborationSettings} CollaborationSettings */\n/** @typedef {import('../../..').CollaborationTransport} CollaborationTransport */\n/** @typedef {import('../../..').CollaborationTransportDocMessage} CollaborationTransportDocMessage */\n/** @typedef {import('../../..').CollaborationTransportSelectionMessage} CollaborationTransportSelectionMessage */\n/** @typedef {import('../../..').EditorSelection} EditorSelection */\n/** @typedef {import('..').OnUpdate} OnUpdate */\n\nconst DEBOUNCE_WAIT_MS = 800;\nconst defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {object} opts - Hook options\n * @param {object[]} opts.blocks\n * @param {OnUpdate} opts.onRemoteDataChange - Function to update editor blocks in redux state.\n * @param {CollaborationSettings} opts.settings\n * @param {() => IsoEditorSelection} opts.getSelection\n * @param {import('../../../store/peers/actions').setAvailablePeers} opts.setAvailablePeers\n * @param {import('../../../store/peers/actions').setPeerSelection} opts.setPeerSelection\n *\n * @typedef IsoEditorSelection\n * @property {object} selectionStart\n * @property {object} selectionEnd\n */\nasync function initYDoc( { blocks, onRemoteDataChange, settings, getSelection, setPeerSelection, setAvailablePeers } ) {\n\tconst { channelId, transport } = settings;\n\n\t/** @type string */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\tapplyDataChanges: updatePostDoc,\n\t\tgetData: postDocToObject,\n\t\t/** @param {object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\n\t\t\tconst { selectionStart, selectionEnd } = getSelection() || {};\n\t\t\tdebug( 'sendSelection', selectionStart, selectionEnd );\n\t\t\ttransport.sendMessage( {\n\t\t\t\ttype: 'selection',\n\t\t\t\tidentity,\n\t\t\t\tselection: {\n\t\t\t\t\tstart: selectionStart,\n\t\t\t\t\tend: selectionEnd,\n\t\t\t\t},\n\t\t\t} );\n\t\t},\n\t} );\n\n\t/** @param {CollaborationTransportDocMessage|CollaborationTransportSelectionMessage} data */\n\tconst onReceiveMessage = ( data ) => {\n\t\tdebug( 'remote change received by transport', data );\n\n\t\tswitch ( data.type ) {\n\t\t\tcase 'doc': {\n\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'selection': {\n\t\t\t\tsetPeerSelection( data.identity, data.selection );\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tdoc.onRemoteDataChange( ( changes ) => {\n\t\tdebug( 'remote change received by ydoc', changes );\n\t\tonRemoteDataChange( changes.blocks );\n\t} );\n\n\treturn transport\n\t\t.connect( {\n\t\t\tuser: {\n\t\t\t\tidentity,\n\t\t\t\tname: settings.username,\n\t\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\t},\n\t\t\tonReceiveMessage,\n\t\t\tsetAvailablePeers: ( peers ) => {\n\t\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\t\tsetAvailablePeers( peers );\n\t\t\t},\n\t\t\tchannelId,\n\t\t} )\n\t\t.then( ( { isFirstInChannel } ) => {\n\t\t\tdebug( `connected (channelId: ${ channelId })` );\n\n\t\t\tif ( isFirstInChannel ) {\n\t\t\t\tdebug( 'first in channel' );\n\t\t\t\tdoc.startSharing( { title: '', blocks } );\n\t\t\t} else {\n\t\t\t\tdoc.connect();\n\t\t\t}\n\n\t\t\tconst disconnect = () => {\n\t\t\t\ttransport.disconnect();\n\t\t\t\tdoc.disconnect();\n\t\t\t};\n\n\t\t\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\t\t\treturn { doc, disconnect };\n\t\t} );\n}\n\n/**\n * @param {object} opts - Hook options\n * @param {object[]} opts.blocks\n * @param {OnUpdate} opts.onRemoteDataChange\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { blocks, onRemoteDataChange, settings } ) {\n\tconst applyChangesToYjs = useRef( noop );\n\n\tconst getSelection = useSelect( ( select ) => {\n\t\treturn select( 'isolated/editor' ).getEditorSelection;\n\t}, [] );\n\n\tconst { setAvailablePeers, setPeerSelection } = useDispatch( 'isolated/editor' );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab caret format' );\n\t\tregisterFormatCollabCaret();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tblocks,\n\t\t\tonRemoteDataChange,\n\t\t\tsettings,\n\t\t\tgetSelection,\n\t\t\tsetPeerSelection,\n\t\t\tsetAvailablePeers,\n\t\t} ).then( ( { doc, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tapplyChangesToYjs.current = debounce( ( blocks ) => {\n\t\t\t\tdebug( 'local changes applied to ydoc' );\n\n\t\t\t\tdoc.applyDataChanges( { blocks } );\n\t\t\t}, DEBOUNCE_WAIT_MS );\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tapplyChangesToYjs.current( blocks );\n\t}, [ blocks ] );\n}\n"],"file":"index.js"}