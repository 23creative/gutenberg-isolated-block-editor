{"version":3,"sources":["../../../src/components/with-registry-provider/effects.js"],"names":["findKey","speak","getBlockType","doBlocksMatchTemplate","switchToBlockType","synchronizeBlocksWithTemplate","cloneBlock","_n","sprintf","create","toHTMLString","insert","remove","storeConfig","blockEditorStoreConfig","replaceBlocks","selectBlock","setTemplateValidity","resetBlocks","selectionChange","actions","getBlock","getBlocks","getSelectedBlockCount","getTemplateLock","getTemplate","isValidTemplate","getSelectionStart","selectors","validateBlocksToTemplate","action","store","state","getState","template","templateLock","isBlocksValidToTemplate","blocks","MERGE_BLOCKS","dispatch","clientIdA","clientIdB","blockA","blockAType","name","merge","clientId","blockB","blockBType","attributeKey","offset","selectedBlockType","attributeDefinition","attributes","canRestoreTextSelection","undefined","window","console","error","START_OF_SELECTED_AREA","cloneA","cloneB","selectedBlock","html","multiline","multilineTag","__unstableMultilineWrapperTags","multilineWrapperTags","__unstablePreserveWhiteSpace","preserveWhiteSpace","value","blocksWithTheSameType","length","updatedAttributes","newAttributeKey","v","indexOf","convertedHtml","convertedValue","newOffset","text","newValue","newHtml","slice","RESET_BLOCKS","MULTI_SELECT","blockCount","SYNCHRONIZE_TEMPLATE","updatedBlockList","MARK_AUTOMATIC_CHANGE","setTimeout","requestIdleCallback","callback","type"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { findKey } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { speak } from '@wordpress/a11y';\nimport {\n\tgetBlockType,\n\tdoBlocksMatchTemplate,\n\tswitchToBlockType,\n\tsynchronizeBlocksWithTemplate,\n\tcloneBlock,\n} from '@wordpress/blocks';\nimport { _n, sprintf } from '@wordpress/i18n';\nimport { create, toHTMLString, insert, remove } from '@wordpress/rich-text';\n\n/**\n * Internal dependencies\n */\nimport { storeConfig as blockEditorStoreConfig } from '@wordpress/block-editor';\nconst {\n\treplaceBlocks,\n\tselectBlock,\n\tsetTemplateValidity,\n\tresetBlocks,\n\tselectionChange,\n} = blockEditorStoreConfig.actions;\nconst {\n\tgetBlock,\n\tgetBlocks,\n\tgetSelectedBlockCount,\n\tgetTemplateLock,\n\tgetTemplate,\n\tisValidTemplate,\n\tgetSelectionStart,\n} = blockEditorStoreConfig.selectors;\n\n/**\n * Block validity is a function of blocks state (at the point of a\n * reset) and the template setting. As a compromise to its placement\n * across distinct parts of state, it is implemented here as a side-\n * effect of the block reset action.\n *\n * @param {Object} action RESET_BLOCKS action.\n * @param {Object} store  Store instance.\n *\n * @return {?Object} New validity set action if validity has changed.\n */\nexport function validateBlocksToTemplate( action, store ) {\n\tconst state = store.getState();\n\tconst template = getTemplate( state );\n\tconst templateLock = getTemplateLock( state );\n\n\t// Unlocked templates are considered always valid because they act\n\t// as default values only.\n\tconst isBlocksValidToTemplate =\n\t\t! template || templateLock !== 'all' || doBlocksMatchTemplate( action.blocks, template );\n\n\t// Update if validity has changed.\n\tif ( isBlocksValidToTemplate !== isValidTemplate( state ) ) {\n\t\treturn setTemplateValidity( isBlocksValidToTemplate );\n\t}\n}\n\nexport default {\n\tMERGE_BLOCKS( action, store ) {\n\t\tconst { dispatch } = store;\n\t\tconst state = store.getState();\n\t\tconst [ clientIdA, clientIdB ] = action.blocks;\n\t\tconst blockA = getBlock( state, clientIdA );\n\t\tconst blockAType = getBlockType( blockA.name );\n\n\t\t// Only focus the previous block if it's not mergeable\n\t\tif ( ! blockAType.merge ) {\n\t\t\tdispatch( selectBlock( blockA.clientId ) );\n\t\t\treturn;\n\t\t}\n\n\t\tconst blockB = getBlock( state, clientIdB );\n\t\tconst blockBType = getBlockType( blockB.name );\n\t\tconst { clientId, attributeKey, offset } = getSelectionStart( state );\n\t\tconst selectedBlockType = clientId === clientIdA ? blockAType : blockBType;\n\t\tconst attributeDefinition = selectedBlockType.attributes[ attributeKey ];\n\t\tconst canRestoreTextSelection =\n\t\t\t( clientId === clientIdA || clientId === clientIdB ) &&\n\t\t\tattributeKey !== undefined &&\n\t\t\toffset !== undefined &&\n\t\t\t// We cannot restore text selection if the RichText identifier\n\t\t\t// is not a defined block attribute key. This can be the case if the\n\t\t\t// fallback intance ID is used to store selection (and no RichText\n\t\t\t// identifier is set), or when the identifier is wrong.\n\t\t\t!! attributeDefinition;\n\n\t\tif ( ! attributeDefinition ) {\n\t\t\tif ( typeof attributeKey === 'number' ) {\n\t\t\t\twindow.console.error(\n\t\t\t\t\t`RichText needs an identifier prop that is the block attribute key of the attribute it controls. Its type is expected to be a string, but was ${ typeof attributeKey }`\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\twindow.console.error(\n\t\t\t\t\t'The RichText identifier prop does not match any attributes defined by the block.'\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t// A robust way to retain selection position through various transforms\n\t\t// is to insert a special character at the position and then recover it.\n\t\tconst START_OF_SELECTED_AREA = '\\u0086';\n\n\t\t// Clone the blocks so we don't insert the character in a \"live\" block.\n\t\tconst cloneA = cloneBlock( blockA );\n\t\tconst cloneB = cloneBlock( blockB );\n\n\t\tif ( canRestoreTextSelection ) {\n\t\t\tconst selectedBlock = clientId === clientIdA ? cloneA : cloneB;\n\t\t\tconst html = selectedBlock.attributes[ attributeKey ];\n\t\t\tconst {\n\t\t\t\tmultiline: multilineTag,\n\t\t\t\t__unstableMultilineWrapperTags: multilineWrapperTags,\n\t\t\t\t__unstablePreserveWhiteSpace: preserveWhiteSpace,\n\t\t\t} = attributeDefinition;\n\t\t\tconst value = insert(\n\t\t\t\tcreate( {\n\t\t\t\t\thtml,\n\t\t\t\t\tmultilineTag,\n\t\t\t\t\tmultilineWrapperTags,\n\t\t\t\t\tpreserveWhiteSpace,\n\t\t\t\t} ),\n\t\t\t\tSTART_OF_SELECTED_AREA,\n\t\t\t\toffset,\n\t\t\t\toffset\n\t\t\t);\n\n\t\t\tselectedBlock.attributes[ attributeKey ] = toHTMLString( {\n\t\t\t\tvalue,\n\t\t\t\tmultilineTag,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} );\n\t\t}\n\n\t\t// We can only merge blocks with similar types\n\t\t// thus, we transform the block to merge first\n\t\tconst blocksWithTheSameType =\n\t\t\tblockA.name === blockB.name ? [ cloneB ] : switchToBlockType( cloneB, blockA.name );\n\n\t\t// If the block types can not match, do nothing\n\t\tif ( ! blocksWithTheSameType || ! blocksWithTheSameType.length ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Calling the merge to update the attributes and remove the block to be merged\n\t\tconst updatedAttributes = blockAType.merge( cloneA.attributes, blocksWithTheSameType[ 0 ].attributes );\n\n\t\tif ( canRestoreTextSelection ) {\n\t\t\tconst newAttributeKey = findKey(\n\t\t\t\tupdatedAttributes,\n\t\t\t\t( v ) => typeof v === 'string' && v.indexOf( START_OF_SELECTED_AREA ) !== -1\n\t\t\t);\n\t\t\tif ( newAttributeKey === undefined ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst convertedHtml = updatedAttributes[ newAttributeKey ];\n\t\t\tconst {\n\t\t\t\tmultiline: multilineTag,\n\t\t\t\t__unstableMultilineWrapperTags: multilineWrapperTags,\n\t\t\t\t__unstablePreserveWhiteSpace: preserveWhiteSpace,\n\t\t\t} = blockAType.attributes[ newAttributeKey ];\n\t\t\tconst convertedValue = create( {\n\t\t\t\thtml: convertedHtml,\n\t\t\t\tmultilineTag,\n\t\t\t\tmultilineWrapperTags,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} );\n\t\t\tconst newOffset = convertedValue.text.indexOf( START_OF_SELECTED_AREA );\n\t\t\tconst newValue = remove( convertedValue, newOffset, newOffset + 1 );\n\t\t\tconst newHtml = toHTMLString( {\n\t\t\t\tvalue: newValue,\n\t\t\t\tmultilineTag,\n\t\t\t\tpreserveWhiteSpace,\n\t\t\t} );\n\n\t\t\tupdatedAttributes[ newAttributeKey ] = newHtml;\n\n\t\t\tdispatch( selectionChange( blockA.clientId, newAttributeKey, newOffset, newOffset ) );\n\t\t}\n\n\t\tdispatch(\n\t\t\treplaceBlocks(\n\t\t\t\t[ blockA.clientId, blockB.clientId ],\n\t\t\t\t[\n\t\t\t\t\t{\n\t\t\t\t\t\t...blockA,\n\t\t\t\t\t\tattributes: {\n\t\t\t\t\t\t\t...blockA.attributes,\n\t\t\t\t\t\t\t...updatedAttributes,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t...blocksWithTheSameType.slice( 1 ),\n\t\t\t\t]\n\t\t\t)\n\t\t);\n\t},\n\tRESET_BLOCKS: [ validateBlocksToTemplate ],\n\tMULTI_SELECT: ( action, { getState } ) => {\n\t\tconst blockCount = getSelectedBlockCount( getState() );\n\n\t\tspeak(\n\t\t\tsprintf(\n\t\t\t\t/* translators: %s: number of selected blocks */\n\t\t\t\t_n( '%s block selected.', '%s blocks selected.', blockCount ),\n\t\t\t\tblockCount\n\t\t\t),\n\t\t\t'assertive'\n\t\t);\n\t},\n\tSYNCHRONIZE_TEMPLATE( action, { getState } ) {\n\t\tconst state = getState();\n\t\tconst blocks = getBlocks( state );\n\t\tconst template = getTemplate( state );\n\t\tconst updatedBlockList = synchronizeBlocksWithTemplate( blocks, template );\n\n\t\treturn resetBlocks( updatedBlockList );\n\t},\n\tMARK_AUTOMATIC_CHANGE( action, store ) {\n\t\t// @ts-ignore */}\n\t\tconst { setTimeout, requestIdleCallback = ( callback ) => setTimeout( callback, 100 ) } = window;\n\n\t\trequestIdleCallback( () => {\n\t\t\tstore.dispatch( { type: 'MARK_AUTOMATIC_CHANGE_FINAL' } );\n\t\t} );\n\t},\n};\n"],"file":"effects.js"}