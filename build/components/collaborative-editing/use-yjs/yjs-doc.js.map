{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-doc.js"],"names":["encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","identity","applyChangesToYDoc","getPostFromYDoc","sendMessage","doc","yjs","Doc","state","yDocTriggeredChangeListeners","connectionReadyListeners","on","update","origin","newData","forEach","listener","isLocalOrigin","UndoManager","protocol","messageType","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","data","isInitialContent","transactionOrigin","transact","connect","disconnect","startSharing","receiveMessage","content","encodeStateAsUpdate","applyUpdate","onYDocTriggeredChange","push","filter","l","onConnectionReady","getState","getPostMap","getMap"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/** @typedef {import('./algorithms/yjs').PostObject} PostObject */\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\n/**\n * Create a Yjs document.\n *\n * @param {Object} opts\n * @param {string} opts.identity - Client identifier.\n * @param {function(yjs.Doc, PostObject): void} opts.applyChangesToYDoc - Function to apply changes to the Yjs doc.\n * @param {function(yjs.Doc): PostObject} opts.getPostFromYDoc - Function to get post object data from the Yjs doc.\n * @param {function(any): void} opts.sendMessage\n */\nexport function createDocument( { identity, applyChangesToYDoc, getPostFromYDoc, sendMessage } ) {\n\tconst doc = new yjs.Doc();\n\t/** @type {'off'|'connecting'|'on'} */\n\tlet state = 'off';\n\n\tlet yDocTriggeredChangeListeners = [];\n\tlet connectionReadyListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\t// Change received from peer, or triggered by self undo/redo\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = getPostFromYDoc( doc );\n\t\t\tyDocTriggeredChangeListeners.forEach( ( listener ) => listener( newData ) );\n\t\t}\n\n\t\tconst isLocalOrigin =\n\t\t\torigin === identity || origin === `no-undo--${ identity }` || origin instanceof yjs.UndoManager;\n\n\t\t// Change should be broadcast to peers\n\t\tif ( isLocalOrigin && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\n\t\tif ( newState === 'on' ) {\n\t\t\tconnectionReadyListeners.forEach( ( listener ) => listener() );\n\t\t}\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\tapplyChangesToYDoc( data, { isInitialContent = false } = {} ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tconst transactionOrigin = isInitialContent ? `no-undo--${ identity }` : identity;\n\n\t\t\tdoc.transact( () => {\n\t\t\t\tapplyChangesToYDoc( doc, data );\n\t\t\t}, transactionOrigin );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\n\t\t\tthis.applyChangesToYDoc( data, { isInitialContent: true } );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif ( content.destination && content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray( yjs.encodeStateAsUpdate( doc, decodeArray( content.stateVector ) ) ),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonYDocTriggeredChange( listener ) {\n\t\t\tyDocTriggeredChangeListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tyDocTriggeredChangeListeners = yDocTriggeredChangeListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonConnectionReady( listener ) {\n\t\t\tconnectionReadyListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tconnectionReadyListeners = connectionReadyListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\n\t\tgetPostMap() {\n\t\t\treturn doc.getMap( 'post' );\n\t\t},\n\t};\n}\n"],"file":"yjs-doc.js"}