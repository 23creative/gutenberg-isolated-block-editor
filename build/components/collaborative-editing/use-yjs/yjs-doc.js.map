{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/yjs-doc.js"],"names":["encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","identity","relativePositionManager","sendMessage","doc","yjs","Doc","state","yDocTriggeredChangeListeners","connectionReadyListeners","on","update","origin","peers","setAbsolutePositions","newData","sanitize","forEach","listener","self","setAbsolutePosition","isLocalOrigin","UndoManager","protocol","messageType","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","applyLocalChangesToYDoc","data","isInitialContent","richTextHint","saveRelativePositions","transactionOrigin","transact","connect","disconnect","startSharing","receiveMessage","content","encodeStateAsUpdate","applyUpdate","saveRelativePosition","onYDocTriggeredChange","push","filter","l","onConnectionReady","getState","getDoc","getPostMap","getMap"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport * as yjs from 'yjs';\n\n/**\n * Internal dependencies\n */\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/** @typedef {import('./algorithms/yjs').PostObject} PostObject */\n/** @typedef {import('./algorithms/relative-position').RelativePositionManager} RelativePositionManager */\n/** @typedef {import('..').RichTextHint} RichTextHint */\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\n/**\n * Create a Yjs document.\n *\n * @param {Object} opts\n * @param {RelativePositionManager} opts.relativePositionManager - Module to coordinate conversions between the block editor selection and Y.RelativePosition.\n * @param {string} opts.identity - Client identifier.\n * @param {function(Record<string, unknown>): void} opts.sendMessage\n */\nexport function createDocument( { identity, relativePositionManager, sendMessage } ) {\n\tconst doc = new yjs.Doc();\n\t/** @type {'off'|'connecting'|'on'} */\n\tlet state = 'off';\n\n\tlet yDocTriggeredChangeListeners = [];\n\tlet connectionReadyListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\trelativePositionManager.peers.setAbsolutePositions( doc );\n\n\t\t// Change received from peer, or triggered by self undo/redo\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = postDocToObject( doc, { sanitize: true } );\n\t\t\tyDocTriggeredChangeListeners.forEach( ( listener ) => listener( newData ) );\n\t\t\trelativePositionManager.self.setAbsolutePosition( doc );\n\t\t}\n\n\t\tconst isLocalOrigin =\n\t\t\torigin === identity || origin === `no-undo--${ identity }` || origin instanceof yjs.UndoManager;\n\n\t\t// Change should be broadcast to peers\n\t\tif ( isLocalOrigin && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\n\t\tif ( newState === 'on' ) {\n\t\t\tconnectionReadyListeners.forEach( ( listener ) => listener() );\n\t\t}\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\t/**\n\t\t * @param {PostObject} data\n\t\t * @param {Object} [opts]\n\t\t * @param {boolean} [opts.isInitialContent] Whether this is the initial content loaded from the editor onLoad.\n\t\t * @param {RichTextHint} [opts.richTextHint] Indication that a certain block attribute is a RichText, inferred from the current editor selection.\n\t\t */\n\t\tapplyLocalChangesToYDoc( data, { isInitialContent = false, richTextHint } = {} ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\trelativePositionManager.peers.saveRelativePositions( doc );\n\n\t\t\tconst transactionOrigin = isInitialContent ? `no-undo--${ identity }` : identity;\n\n\t\t\tdoc.transact( () => {\n\t\t\t\tupdatePostDoc( doc, data, richTextHint );\n\t\t\t}, transactionOrigin );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\n\t\t\tthis.applyLocalChangesToYDoc( data, { isInitialContent: true } );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif ( content.destination && content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray( yjs.encodeStateAsUpdate( doc, decodeArray( content.stateVector ) ) ),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\trelativePositionManager.self.saveRelativePosition( doc );\n\t\t\t\t\trelativePositionManager.peers.saveRelativePositions( doc );\n\t\t\t\t\tyjs.applyUpdate( doc, decodeArray( content.update ), origin );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonYDocTriggeredChange( listener ) {\n\t\t\tyDocTriggeredChangeListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tyDocTriggeredChangeListeners = yDocTriggeredChangeListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonConnectionReady( listener ) {\n\t\t\tconnectionReadyListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tconnectionReadyListeners = connectionReadyListeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\n\t\tgetDoc() {\n\t\t\treturn doc;\n\t\t},\n\n\t\tgetPostMap() {\n\t\t\treturn doc.getMap( 'post' );\n\t\t},\n\t};\n}\n"],"file":"yjs-doc.js"}