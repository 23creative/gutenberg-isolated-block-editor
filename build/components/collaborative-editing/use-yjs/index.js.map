{"version":3,"sources":["../../../../src/components/collaborative-editing/use-yjs/index.js"],"names":["debug","require","defaultColors","initYDoc","settings","registry","channelId","transport","dispatch","select","identity","doc","applyChangesToYDoc","updatePostDoc","getPostFromYDoc","postDocToObject","sendMessage","message","type","onConnectionReady","setYDoc","getPostMap","onYDocTriggeredChange","changes","updateBlocksWithUndo","blocks","isTriggeredByYDoc","connect","user","name","username","color","caretColor","avatarUrl","onReceiveMessage","data","receiveMessage","setCollabPeerSelection","selection","setAvailablePeers","peers","setAvailableCollabPeers","isFirstInChannel","startSharing","title","getBlocks","disconnect","window","addEventListener","sendSelection","start","end","removeEventListener","useYjs","onSelectionChange","noop","getFormatType","selectionStart","getSelectionStart","selectionEnd","getSelectionEnd","enabled","console","error","onUnmount","then","current"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as uuidv4 } from 'uuid';\nimport { noop, once, sample } from 'lodash';\n\n/**\n * Internal dependencies\n */\nimport { createDocument } from './yjs-doc';\nimport { postDocToObject, updatePostDoc } from './algorithms/yjs';\n\n/**\n * WordPress dependencies\n */\nimport { useRegistry, useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\n/**\n * Internal dependencies\n */\nimport { addCollabFilters } from './filters';\nimport { registerCollabFormats } from './formats';\nimport { setupUndoManager } from './yjs-undo';\n\nconst debug = require( 'debug' )( 'iso-editor:collab' );\n\n/** @typedef {import('..').CollaborationSettings} CollaborationSettings */\n\nexport const defaultColors = [ '#4676C0', '#6F6EBE', '#9063B6', '#C3498D', '#9E6D14', '#3B4856', '#4A807A' ];\n\n/**\n * @param {Object} opts\n * @param {import('..').CollaborationSettings} opts.settings\n * @param {Object} opts.registry - Redux data registry for this context.\n */\nasync function initYDoc( { settings, registry } ) {\n\tconst { channelId, transport } = settings;\n\tconst { dispatch, select } = registry;\n\n\t/** @type {string} */\n\tconst identity = uuidv4();\n\n\tdebug( `initYDoc (identity: ${ identity })` );\n\n\tconst doc = createDocument( {\n\t\tidentity,\n\t\tapplyChangesToYDoc: updatePostDoc,\n\t\tgetPostFromYDoc: postDocToObject,\n\t\t/** @param {Object} message */\n\t\tsendMessage: ( message ) => {\n\t\t\tdebug( 'sendDocMessage', message );\n\t\t\ttransport.sendMessage( { type: 'doc', identity, message } );\n\t\t},\n\t} );\n\n\tdoc.onConnectionReady(\n\t\tonce( () => {\n\t\t\tdispatch( 'isolated/editor' ).setYDoc( doc );\n\t\t\tsetupUndoManager( doc.getPostMap(), identity, registry );\n\t\t} )\n\t);\n\n\tdoc.onYDocTriggeredChange( ( changes ) => {\n\t\tdebug( 'changes triggered by ydoc, applying to editor state', changes );\n\t\tdispatch( 'isolated/editor' ).updateBlocksWithUndo( changes.blocks, { isTriggeredByYDoc: true } );\n\t} );\n\n\tconst { isFirstInChannel } = await transport.connect( {\n\t\tuser: {\n\t\t\tidentity,\n\t\t\tname: settings.username,\n\t\t\tcolor: settings.caretColor || sample( defaultColors ),\n\t\t\tavatarUrl: settings.avatarUrl,\n\t\t},\n\t\t/** @param {import('..').CollaborationTransportMessage} data */\n\t\tonReceiveMessage: ( data ) => {\n\t\t\tdebug( 'remote change received by transport', data );\n\n\t\t\tswitch ( data.type ) {\n\t\t\t\tcase 'doc': {\n\t\t\t\t\tdoc.receiveMessage( data.message );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'selection': {\n\t\t\t\t\tdispatch( 'isolated/editor' ).setCollabPeerSelection( data.identity, data.selection );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tsetAvailablePeers: ( peers ) => {\n\t\t\tdebug( 'setAvailablePeers', peers );\n\t\t\tdispatch( 'isolated/editor' ).setAvailableCollabPeers( peers );\n\t\t},\n\t\tchannelId,\n\t} );\n\n\tdebug( `connected (channelId: ${ channelId })` );\n\n\tif ( isFirstInChannel ) {\n\t\tdebug( 'first in channel' );\n\n\t\t// Fetching the blocks from redux now, after the transport has successfully connected,\n\t\t// ensures that we don't initialize the Yjs doc with stale blocks.\n\t\t// (This can happen if <IsolatedBlockEditor> is given an onLoad handler.)\n\t\tdoc.startSharing( { title: '', blocks: select( 'core/block-editor' ).getBlocks() } );\n\t} else {\n\t\tdoc.connect();\n\t}\n\n\tconst disconnect = () => {\n\t\ttransport.disconnect();\n\t\tdoc.disconnect();\n\t};\n\n\twindow.addEventListener( 'beforeunload', () => disconnect() );\n\n\treturn {\n\t\tsendSelection: ( start, end ) => {\n\t\t\tdebug( 'sendSelection', start, end );\n\t\t\ttransport.sendMessage( {\n\t\t\t\ttype: 'selection',\n\t\t\t\tidentity,\n\t\t\t\tselection: {\n\t\t\t\t\tstart,\n\t\t\t\t\tend,\n\t\t\t\t},\n\t\t\t} );\n\t\t},\n\t\tdisconnect: () => {\n\t\t\twindow.removeEventListener( 'beforeunload', disconnect );\n\t\t\tdisconnect();\n\t\t},\n\t};\n}\n\n/**\n * @param {Object} opts - Hook options\n * @param {CollaborationSettings} [opts.settings]\n */\nexport default function useYjs( { settings } ) {\n\tconst onSelectionChange = useRef( noop );\n\tconst registry = useRegistry();\n\n\tconst { getFormatType, selectionStart, selectionEnd } = useSelect( ( select ) => {\n\t\treturn {\n\t\t\tgetFormatType: select( 'core/rich-text' ).getFormatType,\n\t\t\tselectionStart: select( 'core/block-editor' ).getSelectionStart(),\n\t\t\tselectionEnd: select( 'core/block-editor' ).getSelectionEnd(),\n\t\t};\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tif ( ! settings?.enabled ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! settings.transport ) {\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.error( `Collaborative editor is disabled because a transport module wasn't provided.` );\n\t\t\treturn;\n\t\t}\n\n\t\tdebug( 'registered collab formats' );\n\t\tregisterCollabFormats( getFormatType );\n\n\t\tdebug( 'added collab filters' );\n\t\taddCollabFilters();\n\n\t\tlet onUnmount = noop;\n\n\t\tinitYDoc( {\n\t\t\tsettings,\n\t\t\tregistry,\n\t\t} ).then( ( { sendSelection, disconnect } ) => {\n\t\t\tonUnmount = () => {\n\t\t\t\tdebug( 'unmount' );\n\t\t\t\tdisconnect();\n\t\t\t};\n\n\t\t\tonSelectionChange.current = sendSelection;\n\t\t} );\n\n\t\treturn () => onUnmount();\n\t}, [] );\n\n\tuseEffect( () => {\n\t\tonSelectionChange.current( selectionStart, selectionEnd );\n\t}, [ selectionStart, selectionEnd ] );\n}\n"],"file":"index.js"}