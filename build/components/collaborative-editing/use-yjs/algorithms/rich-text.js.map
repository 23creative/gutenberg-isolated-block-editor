{"version":3,"sources":["../../../../../src/components/collaborative-editing/use-yjs/algorithms/rich-text.js"],"names":["OBJECT_REPLACEMENT_CHARACTER","gutenFormatsToYFormats","formats","findIndexOfEqualFormat","needle","haystack","findIndex","f","visited","Array","length","fill","map","yFormats","forEach","formatsForChar","charIdx","fIdx","fLength","ci","foundIndex","push","format","namedGutenFormatToStandardTags","index","formatTypeRecord","getFormatType","type","tagName","attributes","remappedEntries","Object","entries","key","value","fromEntries","getInferredMultilineTag","html","trimmedHtml","trim","test","undefined","prepareReplacementsForTransaction","a","b","partitionReplacementTypes","arr","multilineWrapperReplacements","normalReplacements","r","isArray","na","nb","replacementsDiff","diff","simpleDiffArray","applyHTMLDelta","htmlA","htmlB","richTextMap","richTextOpts","multilineTagA","multilineTagB","inferredMultilineTag","inferredMultilineWrapperTags","mergedRichTextOpts","multilineTag","multilineWrapperTags","set","stringDiff","simpleDiffString","text","previousCharFormats","nullifierFormat","reduce","acc","replacements","doc","transact","get","remove","insert","yfa","yfb","formatsDiff","isEqual","slice","keys","richTextMapToHTML","toString","stringAsMultiline","replacement","replacementHTML","replace","getMultilineWrapperTagHTMLReplacements","str","replacementsHTML","currentMultilineWrappers","foundLineSeparatorIndex","indexOf","__UNSTABLE_LINE_SEPARATOR","multilineWrappers","d","reverse","multilineWrapper","isOpeningTag","wrapperTagReplacements","split","line","i","join"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport * as diff from 'lib0/diff';\nimport { isEqual } from 'lodash';\n\n/** @typedef {import(\"yjs\").XmlText} Y.XmlText */\n\n/**\n * WordPress dependencies\n */\nimport { select } from '@wordpress/data';\nimport { create, toHTMLString, __UNSTABLE_LINE_SEPARATOR } from '@wordpress/rich-text';\n\nconst OBJECT_REPLACEMENT_CHARACTER = '\\ufffc'; // defined in @wordpress/rich-text special-characters\n\n/**\n * Convert an array of Gutenberg RichText formats to an array of range-based Y.Text formats.\n *\n * @param {Object[]} formats\n * @returns {Object[]} Y.Text formats\n */\nexport function gutenFormatsToYFormats( formats ) {\n\tconst findIndexOfEqualFormat = ( needle, haystack = [] ) => haystack.findIndex( ( f ) => needle === f );\n\tconst visited = Array( formats.length )\n\t\t.fill( null )\n\t\t.map( () => ( {} ) );\n\tconst yFormats = [];\n\n\tformats.forEach( ( formatsForChar, charIdx ) => {\n\t\tformatsForChar.forEach( ( f, fIdx ) => {\n\t\t\tif ( visited[ charIdx ][ fIdx ] ) return;\n\n\t\t\tlet fLength = 1;\n\n\t\t\tfor ( let ci = charIdx + 1; ci < formats.length; ci++ ) {\n\t\t\t\tconst foundIndex = findIndexOfEqualFormat( f, formats[ ci ] );\n\t\t\t\tif ( foundIndex === -1 ) break;\n\n\t\t\t\tvisited[ ci ][ foundIndex ] = true;\n\t\t\t\tfLength++;\n\t\t\t}\n\n\t\t\tyFormats.push( {\n\t\t\t\tformat: namedGutenFormatToStandardTags( f ),\n\t\t\t\tindex: charIdx,\n\t\t\t\tlength: fLength,\n\t\t\t} );\n\t\t} );\n\t} );\n\n\treturn yFormats;\n}\n\n/**\n * Converts registered formats back to their standard tag/attribute names.\n *\n * For example, `core/bold` will be converted back to `strong`.\n */\nexport function namedGutenFormatToStandardTags( format ) {\n\tconst formatTypeRecord = select( 'core/rich-text' ).getFormatType( format.type );\n\tif ( ! formatTypeRecord ) return { [ format.type ]: true };\n\n\tconst { tagName, attributes = {} } = formatTypeRecord;\n\tif ( ! format.attributes ) return { [ tagName ]: true };\n\n\tconst remappedEntries = Object.entries( format.attributes ).map( ( [ key, value ] ) => [\n\t\tattributes[ key ],\n\t\tvalue,\n\t] );\n\treturn { [ tagName ]: Object.fromEntries( remappedEntries ) };\n}\n\n// TODO: Unsolved problem\n// This is an imperfect inferral, so ideally we want to get this information\n// from Gutenberg's internal representation of the RichText.\nfunction getInferredMultilineTag( html ) {\n\tconst trimmedHtml = html.trim();\n\tif ( /^<li>/.test( trimmedHtml ) ) return 'li';\n\tif ( /^<p>/.test( trimmedHtml ) ) return 'p';\n\treturn undefined;\n}\n\n/**\n * Massage the Gutenberg replacements into Yjs-friendly structures.\n *\n * @param {array} a The `replacements` array of a Gutenberg RichText.\n * @param {array} b The `replacements` array of another Gutenberg RichText.\n */\nfunction prepareReplacementsForTransaction( a, b ) {\n\tconst partitionReplacementTypes = ( arr ) => {\n\t\tlet multilineWrapperReplacements = {};\n\t\tlet normalReplacements = [];\n\n\t\tarr.forEach( ( r, index ) => {\n\t\t\tif ( Array.isArray( r ) ) {\n\t\t\t\t// If it's an array, it's a multiline wrapper tag (e.g. ul/ol) and not a normal replacement.\n\t\t\t\tmultilineWrapperReplacements[ index ] = r;\n\t\t\t} else if ( r ) {\n\t\t\t\t// Since normal replacements do not rely on an index-based mapping\n\t\t\t\t// with the full text, let's condense the sparse array.\n\t\t\t\tnormalReplacements.push( r );\n\t\t\t}\n\t\t} );\n\t\treturn { multilineWrapperReplacements, normalReplacements };\n\t};\n\n\tconst { normalReplacements: na } = partitionReplacementTypes( a );\n\tconst { multilineWrapperReplacements, normalReplacements: nb } = partitionReplacementTypes( b );\n\n\treturn { multilineWrapperReplacements, replacementsDiff: diff.simpleDiffArray( na, nb ) };\n}\n\n/**\n * Apply the delta between two HTML strings to a Y.XmlText.\n *\n * @param {string} htmlA\n * @param {string} htmlB\n * @param {import(\"yjs\").Map} richTextMap\n * @param {Object} [richTextOpts] Optional options object to pass @wordpress/rich-text create().\n */\nexport function applyHTMLDelta( htmlA, htmlB, richTextMap, richTextOpts = {} ) {\n\tconst [ multilineTagA, multilineTagB ] = [ htmlA, htmlB ].map( getInferredMultilineTag );\n\tconst inferredMultilineTag = multilineTagA || multilineTagB;\n\tconst inferredMultilineWrapperTags = inferredMultilineTag === 'li' ? [ 'ul', 'ol' ] : [];\n\tconst mergedRichTextOpts = {\n\t\t...( inferredMultilineTag ? { multilineTag: inferredMultilineTag } : {} ),\n\t\tmultilineWrapperTags: inferredMultilineWrapperTags,\n\t\t...richTextOpts,\n\t};\n\n\trichTextMap.set( 'multilineTag', inferredMultilineTag );\n\n\tconst a = create( { ...mergedRichTextOpts, html: htmlA } );\n\tconst b = create( { ...mergedRichTextOpts, html: htmlB } );\n\n\tconst stringDiff = diff.simpleDiffString( a.text, b.text );\n\n\t// By default, a Yjs string insertion will inherit the formats of the previous character.\n\t// We need to prevent this by inserting with an explicit format object nullifying the previous formats.\n\tconst previousCharFormats = b.formats[ stringDiff.index - 1 ];\n\tconst nullifierFormat = previousCharFormats?.reduce(\n\t\t( acc, { type } ) => ( {\n\t\t\t...acc,\n\t\t\t[ type ]: null,\n\t\t} ),\n\t\t{}\n\t);\n\n\tconst { multilineWrapperReplacements, replacementsDiff } = prepareReplacementsForTransaction(\n\t\ta.replacements,\n\t\tb.replacements\n\t);\n\n\trichTextMap.doc?.transact( () => {\n\t\trichTextMap.get( 'xmlText' ).delete( stringDiff.index, stringDiff.remove );\n\t\trichTextMap.get( 'xmlText' ).insert( stringDiff.index, stringDiff.insert, nullifierFormat );\n\n\t\tconst yfa = gutenFormatsToYFormats( a.formats );\n\t\tconst yfb = gutenFormatsToYFormats( b.formats );\n\t\tconst formatsDiff = diff.simpleDiffArray( yfa, yfb, isEqual );\n\n\t\tif ( formatsDiff.remove ) {\n\t\t\tyfa.slice( formatsDiff.index, formatsDiff.index + formatsDiff.remove ).forEach( ( f ) => {\n\t\t\t\tconst tagName = Object.keys( f.format )[ 0 ];\n\t\t\t\trichTextMap.get( 'xmlText' ).format( f.index, f.length, { [ tagName ]: null } );\n\t\t\t} );\n\t\t}\n\t\tif ( formatsDiff.insert ) {\n\t\t\tformatsDiff.insert.forEach( ( f ) => richTextMap.get( 'xmlText' ).format( f.index, f.length, f.format ) );\n\t\t}\n\n\t\trichTextMap.get( 'replacements' ).delete( replacementsDiff.index, replacementsDiff.remove );\n\t\trichTextMap.get( 'replacements' ).insert( replacementsDiff.index, replacementsDiff.insert );\n\t\trichTextMap.set( 'multilineWrapperReplacements', multilineWrapperReplacements );\n\t} );\n}\n\n/**\n * Convert the RichText back from our Yjs representation to an HTML string.\n *\n * @param {import(\"yjs\").Map} richTextMap\n * @returns {string}\n */\nexport function richTextMapToHTML( richTextMap ) {\n\tlet text = richTextMap.get( 'xmlText' ).toString();\n\n\t// Process multiline tags\n\tconst multilineTag = richTextMap.get( 'multilineTag' );\n\ttext = multilineTag\n\t\t? stringAsMultiline( text, multilineTag, richTextMap.get( 'multilineWrapperReplacements' ) )\n\t\t: text;\n\n\t// Process replacements (e.g. inline images)\n\trichTextMap.get( 'replacements' ).forEach( ( replacement ) => {\n\t\tconst replacementHTML = toHTMLString( {\n\t\t\tvalue: {\n\t\t\t\treplacements: [ replacement ],\n\t\t\t\tformats: Array( 1 ),\n\t\t\t\ttext: OBJECT_REPLACEMENT_CHARACTER,\n\t\t\t},\n\t\t} );\n\t\ttext = text.replace( OBJECT_REPLACEMENT_CHARACTER, replacementHTML );\n\t} );\n\n\treturn text;\n}\n\n/**\n * Get HTML replacements for each multiline wrapper tag replacement.\n *\n * @param {string} str\n * @param {Record<number, {type: string}[]>} replacements\n */\nfunction getMultilineWrapperTagHTMLReplacements( str, replacements ) {\n\tlet replacementsHTML = [];\n\tlet currentMultilineWrappers = [];\n\tlet foundLineSeparatorIndex = -1;\n\n\tdo {\n\t\tfoundLineSeparatorIndex = str.indexOf( __UNSTABLE_LINE_SEPARATOR, foundLineSeparatorIndex + 1 );\n\t\tconst multilineWrappers = replacements[ foundLineSeparatorIndex ] ?? [];\n\t\tconst d = diff.simpleDiffArray( currentMultilineWrappers, multilineWrappers, isEqual );\n\t\tlet html = '';\n\n\t\t// Closing multiline wrapper tags\n\t\tcurrentMultilineWrappers\n\t\t\t.slice( d.index, d.index + d.remove )\n\t\t\t.reverse()\n\t\t\t.forEach( ( multilineWrapper ) => {\n\t\t\t\thtml += `</${ multilineWrapper.type }></li>`;\n\t\t\t} );\n\n\t\t// Opening multiline wrapper tags\n\t\td.insert.forEach( ( multilineWrapper ) => {\n\t\t\thtml += `<${ multilineWrapper.type }>`;\n\t\t} );\n\n\t\treplacementsHTML.push( { isOpeningTag: !! d.insert.length, html } );\n\t\tcurrentMultilineWrappers = multilineWrappers;\n\t} while ( foundLineSeparatorIndex !== -1 );\n\n\treturn replacementsHTML;\n}\n\n/**\n * Wraps each line of a multiline string with the given tags.\n *\n * @param {string} str A multiline string delimited by __UNSTABLE_LINE_SEPARATOR.\n * @param {string} multilineTag The tag name to wrap each line with.\n * @param {Record<number, {type: string}[]>} replacements Multiline wrapper replacements.\n * @returns {string} The string reconstructed with multiline considerations.\n */\nfunction stringAsMultiline( str, multilineTag, replacements ) {\n\tconst wrapperTagReplacements = getMultilineWrapperTagHTMLReplacements( str, replacements );\n\n\treturn str\n\t\t.split( __UNSTABLE_LINE_SEPARATOR )\n\t\t.map( ( line, i ) => {\n\t\t\tconst { isOpeningTag, html } = wrapperTagReplacements[ i ];\n\n\t\t\treturn isOpeningTag\n\t\t\t\t? `<${ multilineTag }>${ line }${ html }`\n\t\t\t\t: `<${ multilineTag }>${ line }</${ multilineTag }>${ html }`;\n\t\t} )\n\t\t.join( '' );\n}\n"],"file":"rich-text.js"}