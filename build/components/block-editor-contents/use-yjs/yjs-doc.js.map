{"version":3,"sources":["../../../../src/components/block-editor-contents/use-yjs/yjs-doc.js"],"names":["encodeArray","array","toString","decodeArray","string","Uint8Array","split","createDocument","identity","applyDataChanges","getData","sendMessage","doc","yjs","Doc","state","listeners","stateListeners","on","update","origin","protocol","messageType","newData","forEach","listener","setState","newState","sync","destination","isReply","stateVector","encodeStateVector","data","transact","connect","disconnect","startSharing","receiveMessage","content","encodeStateAsUpdate","applyUpdate","onRemoteDataChange","push","filter","l","onStateChange","getState"],"mappings":"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","sourcesContent":["import * as yjs from 'yjs';\n\nconst encodeArray = ( array ) => array.toString();\nconst decodeArray = ( string ) => new Uint8Array( string.split( ',' ) );\n\nexport function createDocument( {\n\tidentity,\n\tapplyDataChanges,\n\tgetData,\n\tsendMessage,\n} ) {\n\tconst doc = new yjs.Doc();\n\tlet state = 'off';\n\tlet listeners = [];\n\tlet stateListeners = [];\n\n\tdoc.on( 'update', ( update, origin ) => {\n\t\tif ( origin === identity && state === 'on' ) {\n\t\t\tsendMessage( {\n\t\t\t\tprotocol: 'yjs1',\n\t\t\t\tmessageType: 'syncUpdate',\n\t\t\t\tupdate: encodeArray( update ),\n\t\t\t} );\n\t\t}\n\n\t\tif ( origin !== identity ) {\n\t\t\tconst newData = getData( doc );\n\t\t\tlisteners.forEach( ( listener ) => listener( newData ) );\n\t\t}\n\t} );\n\n\tconst setState = ( newState ) => {\n\t\tstate = newState;\n\t\tstateListeners.forEach( ( listener ) => listener( newState ) );\n\t};\n\n\tconst sync = ( destination, isReply ) => {\n\t\tconst stateVector = yjs.encodeStateVector( doc );\n\t\tsendMessage( {\n\t\t\tprotocol: 'yjs1',\n\t\t\tmessageType: 'sync1',\n\t\t\tstateVector: encodeArray( stateVector ),\n\t\t\torigin: identity,\n\t\t\tdestination,\n\t\t\tisReply,\n\t\t} );\n\t};\n\n\treturn {\n\t\tapplyDataChanges( data ) {\n\t\t\tif ( state !== 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\t\t\tdoc.transact( () => {\n\t\t\t\tapplyDataChanges( doc, data );\n\t\t\t}, identity );\n\t\t},\n\n\t\tconnect() {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'connecting' );\n\t\t\tsync();\n\t\t},\n\n\t\tdisconnect() {\n\t\t\tsetState( 'off' );\n\t\t},\n\n\t\tstartSharing( data ) {\n\t\t\tif ( state === 'on' ) {\n\t\t\t\tthrow 'wrong state';\n\t\t\t}\n\n\t\t\tsetState( 'on' );\n\t\t\tthis.applyDataChanges( data );\n\t\t},\n\n\t\treceiveMessage( { protocol, messageType, origin, ...content } ) {\n\t\t\tif ( protocol !== 'yjs1' ) {\n\t\t\t\tthrow 'wrong protocol';\n\t\t\t}\n\n\t\t\tswitch ( messageType ) {\n\t\t\t\tcase 'sync1':\n\t\t\t\t\tif (\n\t\t\t\t\t\tcontent.destination &&\n\t\t\t\t\t\tcontent.destination !== identity\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tsendMessage( {\n\t\t\t\t\t\tprotocol: 'yjs1',\n\t\t\t\t\t\tmessageType: 'sync2',\n\t\t\t\t\t\tupdate: encodeArray(\n\t\t\t\t\t\t\tyjs.encodeStateAsUpdate(\n\t\t\t\t\t\t\t\tdoc,\n\t\t\t\t\t\t\t\tdecodeArray( content.stateVector )\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t),\n\t\t\t\t\t\tdestination: origin,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( ! content.isReply ) {\n\t\t\t\t\t\tsync( origin, true );\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'sync2':\n\t\t\t\t\tif ( content.destination !== identity ) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tyjs.applyUpdate(\n\t\t\t\t\t\tdoc,\n\t\t\t\t\t\tdecodeArray( content.update ),\n\t\t\t\t\t\torigin\n\t\t\t\t\t);\n\t\t\t\t\tsetState( 'on' );\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'syncUpdate':\n\t\t\t\t\tyjs.applyUpdate(\n\t\t\t\t\t\tdoc,\n\t\t\t\t\t\tdecodeArray( content.update ),\n\t\t\t\t\t\torigin\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t},\n\n\t\tonRemoteDataChange( listener ) {\n\t\t\tlisteners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tlisteners = listeners.filter( ( l ) => l !== listener );\n\t\t\t};\n\t\t},\n\n\t\tonStateChange( listener ) {\n\t\t\tstateListeners.push( listener );\n\n\t\t\treturn () => {\n\t\t\t\tstateListeners = stateListeners.filter(\n\t\t\t\t\t( l ) => l !== listener\n\t\t\t\t);\n\t\t\t};\n\t\t},\n\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\t};\n}\n"],"file":"yjs-doc.js"}